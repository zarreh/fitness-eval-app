<!DOCTYPE html>
{% set direction = i18n.direction if i18n else "ltr" %}
{% set lang_code = i18n.lang_code if i18n else "en" %}
{% set pdf = i18n.pdf if i18n else {} %}
<html lang="{{ lang_code }}" dir="{{ direction }}">
<head>
  <meta charset="UTF-8" />
  <title>{{ pdf.get('report_title', 'Fitness Assessment Report') }} — {{ report.client.name }}</title>
  {% if direction == "rtl" %}
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" />
  {% endif %}
  <style>
    /* ══════════════════════════════════════════════════════
       CSS VARIABLES — edit here to white-label the report
       ══════════════════════════════════════════════════════ */
    :root {
      --primary:          #1a1a2e;
      --primary-light:    #16213e;
      --accent:           #0f3460;
      --text:             #222222;
      --text-light:       #555555;
      --text-muted:       #888888;
      --bg-light:         #f7f8fc;
      --bg-white:         #ffffff;
      --border:           #e0e0e0;
      --border-light:     #eeeeee;

      /* Rating palette — green (excellent) → red (poor) */
      --c-excellent:      #155724;   --bg-excellent:     #d4edda;
      --c-very-good:      #0b5226;   --bg-very-good:     #b8e8c8;
      --c-good:           #1e6b1e;   --bg-good:          #c8f0c8;
      --c-fair:           #7d5a00;   --bg-fair:          #fff3cd;
      --c-poor:           #721c24;   --bg-poor:          #f8d7da;
    }

    /* ══════════════════════════════════════════════════════
       PAGE SETUP
       ══════════════════════════════════════════════════════ */
    @page {
      size: A4;
      margin: 20mm 18mm 24mm 18mm;

      @top-right {
        content: "{{ report.client.name }}  ·  {{ pdf.get('page_header', 'Fitness Assessment') }}";
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 8pt;
        color: var(--text-muted);
      }
      @bottom-left {
        content: "{{ report.generated_at.strftime('%B %d, %Y') }}";
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 8pt;
        color: var(--text-muted);
      }
      @bottom-right {
        content: "Page " counter(page) " of " counter(pages);
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 8pt;
        color: var(--text-muted);
      }
    }

    /* Suppress running header/footer on the cover page */
    @page :first {
      @top-right  { content: ""; }
      @bottom-left  { content: ""; }
      @bottom-right { content: ""; }
    }

    /* ══════════════════════════════════════════════════════
       BASE TYPOGRAPHY
       ══════════════════════════════════════════════════════ */
    body {
      font-family: {% if direction == "rtl" %}"Vazirmatn", "Tahoma", "Arial Unicode MS", {% endif %}"Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 10.5pt;
      line-height: 1.55;
      color: var(--text);
      margin: 0;
    }

    h2 {
      font-size: 12.5pt;
      font-weight: 700;
      color: var(--primary);
      border-bottom: 2px solid var(--border);
      padding-bottom: 5px;
      margin-top: 24px;
      margin-bottom: 12px;
    }

    /* ══════════════════════════════════════════════════════
       COVER PAGE
       ══════════════════════════════════════════════════════ */
    .cover-page {
      min-height: 245mm;
      display: flex;
      flex-direction: column;
      page-break-after: always;
      break-after: page;
    }

    .cover-logo-area {
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }

    .logo-placeholder {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 130px;
      height: 50px;
      border: 2px dashed var(--border);
      color: #bbb;
      font-size: 8.5pt;
      border-radius: 4px;
    }

    .cover-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 18mm 0 12mm 0;
    }

    .cover-eyebrow {
      font-size: 8.5pt;
      font-weight: 700;
      letter-spacing: 2.5px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .cover-title {
      font-size: 28pt;
      font-weight: 700;
      color: var(--primary);
      line-height: 1.15;
      margin-bottom: 4px;
    }

    .cover-rule {
      width: 55%;
      height: 4px;
      background: var(--primary);
      border: none;
      margin: 16px 0 22px 0;
      {% if direction == "rtl" %}margin-right: 0;{% endif %}
    }

    .cover-client-name {
      font-size: 18pt;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .cover-meta {
      font-size: 10.5pt;
      color: var(--text-light);
      line-height: 1.9;
    }

    .cover-footer {
      border-top: 1px solid var(--border);
      padding-top: 10px;
      font-size: 9pt;
      color: var(--text-muted);
    }

    /* ══════════════════════════════════════════════════════
       CLIENT INFO GRID
       ══════════════════════════════════════════════════════ */
    .client-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 28px;
      background: var(--bg-light);
      border-radius: 6px;
      padding: 14px 18px;
    }

    .client-field label {
      display: block;
      font-size: 8pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-light);
      margin-bottom: 2px;
    }

    .client-field span {
      font-size: 10.5pt;
    }

    /* ══════════════════════════════════════════════════════
       CATEGORY OVERVIEW CARDS
       ══════════════════════════════════════════════════════ */
    .category-cards {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .category-card {
      flex: 1;
      border: 1px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 0 0 6px 6px;
      padding: 10px 12px 12px 12px;
      background: var(--bg-white);
    }

    .cat-label {
      font-size: 7.5pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    .cat-count {
      font-size: 8pt;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* ══════════════════════════════════════════════════════
       RATING BADGES
       ══════════════════════════════════════════════════════ */
    .badge {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 12px;
      font-size: 8.5pt;
      font-weight: 700;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }

    .badge-excellent  { background: var(--bg-excellent);  color: var(--c-excellent); }
    .badge-very-good  { background: var(--bg-very-good);  color: var(--c-very-good); }
    .badge-good       { background: var(--bg-good);       color: var(--c-good); }
    .badge-fair       { background: var(--bg-fair);       color: var(--c-fair); }
    .badge-poor       { background: var(--bg-poor);       color: var(--c-poor); }

    /* ══════════════════════════════════════════════════════
       DETAILED RESULTS TABLE
       ══════════════════════════════════════════════════════ */
    .category-section {
      margin-top: 18px;
      page-break-inside: avoid;
    }

    .category-heading {
      font-size: 9pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-light);
      margin-bottom: 4px;
    }

    .category-rule {
      border: none;
      border-top: 1px solid var(--border);
      margin: 0 0 0 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 10pt;
    }

    thead th {
      background: var(--primary);
      color: #fff;
      text-align: {% if direction == "rtl" %}right{% else %}left{% endif %};
      padding: 7px 10px;
      font-weight: 600;
      font-size: 9pt;
    }

    tbody tr:nth-child(even) { background: var(--bg-light); }
    tbody td {
      padding: 7px 10px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }

    /* ══════════════════════════════════════════════════════
       LLM NARRATIVE (markdown-rendered)
       ══════════════════════════════════════════════════════ */
    .narrative {
      background: var(--bg-light);
      {% if direction == "rtl" %}
      border-right: 4px solid var(--primary);
      border-left: none;
      {% else %}
      border-left: 4px solid var(--primary);
      {% endif %}
      padding: 14px 18px;
      margin-top: 10px;
      border-radius: {% if direction == "rtl" %}6px 0 0 6px{% else %}0 6px 6px 0{% endif %};
      font-size: 10pt;
      line-height: 1.65;
    }

    .narrative h2 {
      font-size: 11pt;
      font-weight: 700;
      color: var(--primary);
      border-bottom: 1px solid var(--border);
      padding-bottom: 3px;
      margin-top: 16px;
      margin-bottom: 8px;
    }

    .narrative h2:first-child {
      margin-top: 0;
    }

    .narrative h3 {
      font-size: 10.5pt;
      font-weight: 700;
      color: var(--primary-light);
      margin-top: 12px;
      margin-bottom: 6px;
    }

    .narrative ul,
    .narrative ol {
      margin: 6px 0 10px 0;
      {% if direction == "rtl" %}
      padding-right: 1.5em;
      padding-left: 0;
      {% else %}
      padding-left: 1.5em;
      {% endif %}
    }

    .narrative ul {
      list-style-type: disc;
    }

    .narrative ol {
      list-style-type: decimal;
    }

    .narrative li {
      margin-bottom: 5px;
    }

    .narrative p {
      margin: 6px 0 10px 0;
    }

    .narrative strong {
      color: var(--primary);
    }

    /* ══════════════════════════════════════════════════════
       PROGRESS INDICATORS
       ══════════════════════════════════════════════════════ */
    .delta-improved {
      color: var(--c-excellent);
      font-weight: 700;
      font-size: 9pt;
    }
    .delta-declined {
      color: var(--c-poor);
      font-weight: 700;
      font-size: 9pt;
    }
    .delta-unchanged {
      color: var(--text-muted);
      font-size: 9pt;
    }
    .prev-value {
      font-size: 8pt;
      color: var(--text-muted);
    }

    /* ══════════════════════════════════════════════════════
       RANGE BARS
       ══════════════════════════════════════════════════════ */
    .range-bar-wrap {
      position: relative;
      margin: 4px 0 2px 0;
    }
    .range-bar {
      display: flex;
      height: 8pt;
      border-radius: 3px;
      overflow: hidden;
      border: 0.5pt solid #ddd;
    }
    .range-bar-zone {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      border-right: 0.5pt solid rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .range-bar-zone span {
      font-size: 5pt;
      color: rgba(0,0,0,0.4);
      white-space: nowrap;
    }
    .range-bar-marker {
      position: absolute;
      top: -1pt;
      transform: translateX(-50%);
      font-size: 8pt;
      line-height: 1;
      color: var(--primary);
    }
    .range-bar-thresh {
      position: relative;
      height: 7pt;
      margin-top: 1pt;
    }
    .range-bar-thresh span {
      position: absolute;
      transform: translateX(-50%);
      font-size: 5pt;
      color: #aaa;
    }

    /* ══════════════════════════════════════════════════════
       PAGE BREAKS & LAYOUT HELPERS
       ══════════════════════════════════════════════════════ */
    .page-break {
      page-break-before: always;
      break-before: page;
    }

    .coach-note {
      font-size: 8.5pt;
      color: var(--text-muted);
      font-style: italic;
      margin-top: -6px;
      margin-bottom: 10px;
    }

    /* ══════════════════════════════════════════════════════
       DISCLAIMER
       ══════════════════════════════════════════════════════ */
    .disclaimer {
      margin-top: 36px;
      padding: 12px 16px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 8.5pt;
      color: var(--text-light);
      line-height: 1.5;
    }
  </style>
</head>
<body>

  <!-- ══════════════════════════════════════════════════════
       COVER PAGE
       ══════════════════════════════════════════════════════ -->
  <div class="cover-page">

    <div class="cover-logo-area">
      <div class="logo-placeholder">Coach Logo</div>
    </div>

    <div class="cover-body">
      <div class="cover-eyebrow">{{ pdf.get('report_title', 'Fitness Assessment Report') }}</div>
      <div class="cover-title">{{ pdf.get('summary_heading', 'Assessment') }}<br>{{ pdf.get('results_heading', 'Report') }}</div>
      <hr class="cover-rule">
      <div class="cover-client-name">{{ report.client.name }}</div>
      <div class="cover-meta">
        {{ pdf.get('date', 'Date') }}: {{ report.generated_at.strftime('%B %d, %Y') }}<br>
        {{ pdf.get('prepared_for', 'Prepared for') }}: {{ report.client.name }}<br>
        {{ report.client.age }}&nbsp;&nbsp;·&nbsp;&nbsp;{{ report.client.gender | title }}<br>
        {{ report.client.goals | join(', ') | replace('_', ' ') | title if report.client.goals else 'Not specified' }}
      </div>
    </div>

    <div class="cover-footer">
      {% if report.coach_name or report.organization %}
        {% if report.coach_name %}{{ pdf.get('prepared_by', 'Prepared by') }}: <strong>{{ report.coach_name }}</strong>{% endif %}
        {% if report.coach_name and report.organization %}&nbsp;&nbsp;·&nbsp;&nbsp;{% endif %}
        {% if report.organization %}{{ report.organization }}{% endif %}
      {% else %}
        Confidential — For Coach Review
      {% endif %}
    </div>

  </div><!-- end cover-page -->


  <!-- ══════════════════════════════════════════════════════
       CLIENT INFORMATION
       ══════════════════════════════════════════════════════ -->
  <h2>{{ pdf.get('prepared_for', 'Client Information') }}</h2>
  <div class="client-grid">
    <div class="client-field">
      <label>{{ pdf.get('test_col', 'Name') }}</label>
      <span>{{ report.client.name }}</span>
    </div>
    <div class="client-field">
      <label>{{ pdf.get('result_col', 'Age') }}</label>
      <span>{{ report.client.age }}</span>
    </div>
    <div class="client-field">
      <label>{{ pdf.get('rating_col', 'Gender') }}</label>
      <span>{{ report.client.gender | title }}</span>
    </div>
    <div class="client-field">
      <label>{{ pdf.get('progress_col', 'Goals') }}</label>
      <span>{{ report.client.goals | join(', ') | replace('_', ' ') | title if report.client.goals else 'Not specified' }}</span>
    </div>
    {% if report.client.height_cm and report.client.weight_kg %}
    <div class="client-field">
      <label>Height / Weight</label>
      <span>{{ report.client.height_cm | fmt }} cm&nbsp;&nbsp;/&nbsp;&nbsp;{{ report.client.weight_kg | fmt }} kg</span>
    </div>
    {% endif %}
    {% if report.client.notes %}
    <div class="client-field" style="grid-column: span 2;">
      <label>Notes</label>
      <span>{{ report.client.notes }}</span>
    </div>
    {% endif %}
  </div>


  <!-- ══════════════════════════════════════════════════════
       RESULTS OVERVIEW CARDS
       ══════════════════════════════════════════════════════ -->
  {% if category_summary %}
  <h2>{{ pdf.get('results_heading', 'Results Overview') }}</h2>
  <div class="category-cards">
    {% for cat in category_summary %}
    {% set badge_class = cat.worst_rating | lower | replace(' ', '-') %}
    <div class="category-card">
      <div class="cat-label">{{ cat.label }}</div>
      <div class="cat-count">{{ cat.count }} test{% if cat.count != 1 %}s{% endif %}</div>
      <span class="badge badge-{{ badge_class }}">{{ rating_labels.get(cat.worst_rating, cat.worst_rating) if rating_labels else cat.worst_rating }}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}


  <!-- ══════════════════════════════════════════════════════
       DETAILED RESULTS (grouped by category)
       ══════════════════════════════════════════════════════ -->
  <h2>{{ pdf.get('results_heading', 'Detailed Assessment Results') }}</h2>

  {% for cat_key, cat_label, cat_results in category_groups %}
  <div class="category-section">
    <div class="category-heading">{{ cat_label }}</div>
    <hr class="category-rule">
    <table>
      <thead>
        <tr>
          <th>{{ pdf.get('test_col', 'Test') }}</th>
          <th>{{ pdf.get('result_col', 'Result') }}</th>
          <th>{{ pdf.get('rating_col', 'Rating') }}</th>
          {% if progress_map %}<th>{{ pdf.get('progress_col', 'Progress') }}</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for result in cat_results %}
        {% set badge_class = result.rating | lower | replace(' ', '-') %}
        {% set col_count = 3 %}{% if progress_map %}{% set col_count = 4 %}{% endif %}
        <tr>
          <td>{{ result.test_name }}</td>
          <td>{{ result.raw_value | fmt }}&nbsp;{{ result.unit }}</td>
          <td><span class="badge badge-{{ badge_class }}">{{ rating_labels.get(result.rating, result.rating) if rating_labels else result.rating }}</span></td>
          {% if progress_map %}
          <td>
            {% set delta = progress_map.get(result.test_name) %}
            {% if delta %}
              {% set sign = "+" if delta.delta >= 0 else "" %}
              {% set delta_str = sign ~ (delta.delta | fmt) %}
              {% set prev_label = rating_labels.get(delta.previous_rating, delta.previous_rating) if rating_labels else delta.previous_rating %}
              {% set curr_label = rating_labels.get(delta.current_rating, delta.current_rating) if rating_labels else delta.current_rating %}
              {% if delta.direction == "improved" %}
                <span class="delta-improved">&#9650; {{ delta_str }}&nbsp;{{ delta.unit }}</span>
                {% if delta.previous_rating != delta.current_rating %}
                <br><span class="prev-value">{{ prev_label }} → {{ curr_label }}</span>
                {% endif %}
              {% elif delta.direction == "declined" %}
                <span class="delta-declined">&#9660; {{ delta_str }}&nbsp;{{ delta.unit }}</span>
                {% if delta.previous_rating != delta.current_rating %}
                <br><span class="prev-value">{{ prev_label }} → {{ curr_label }}</span>
                {% endif %}
              {% else %}
                <span class="delta-unchanged">&#8212; {{ pdf.get('unchanged', 'Unchanged') }}</span>
              {% endif %}
            {% else %}
              <span class="delta-unchanged">{{ pdf.get('new', 'New') }}</span>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% set bar = range_bars.get(result.test_name) if range_bars else None %}
        {% if bar %}
        <tr>
          <td colspan="{{ col_count }}" style="padding:2px 10px 8px 10px;border-bottom:1px solid var(--border-light);">
            <div class="range-bar-wrap">
              <div class="range-bar">
                {% for zone in bar.zones %}
                <div class="range-bar-zone" style="width:{{ zone.width_pct | round(1) }}%;background:{{ zone.color }};"><span>{{ zone.abbr }}</span></div>
                {% endfor %}
              </div>
              <div class="range-bar-marker" style="left:{{ bar.marker_pct | round(1) }}%;">&#9660;</div>
              <div class="range-bar-thresh">
                {% for lbl in bar.threshold_labels %}
                <span style="left:{{ lbl.pct | round(1) }}%;">{{ lbl.val }}</span>
                {% endfor %}
              </div>
            </div>
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}


  <!-- ══════════════════════════════════════════════════════
       ASSESSMENT SUMMARY  (LLM — rendered markdown)
       ══════════════════════════════════════════════════════ -->
  <div class="page-break"></div>
  <h2>{{ pdf.get('summary_heading', 'Assessment Summary') }}</h2>
  <div class="narrative">
    {{ report.llm_summary | md }}
  </div>


  <!-- ══════════════════════════════════════════════════════
       RECOMMENDED WORKOUT PLAN  (LLM — rendered markdown)
       ══════════════════════════════════════════════════════ -->
  <div class="page-break"></div>
  <h2>{{ pdf.get('workout_heading', 'Recommended Workout Plan') }}</h2>
  <p class="coach-note">{{ pdf.get('disclaimer', 'Draft for coach review.') | truncate(80) }}</p>
  <div class="narrative">
    {{ report.workout_suggestions | md }}
  </div>


  <!-- ══════════════════════════════════════════════════════
       DISCLAIMER
       ══════════════════════════════════════════════════════ -->
  <div class="disclaimer">
    {{ pdf.get('disclaimer', 'This report is for informational and coaching purposes only. It does not constitute medical advice, diagnosis, or treatment.') }}
  </div>

</body>
</html>
